"use strict";var j=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var F=Object.getOwnPropertyNames;var E=Object.prototype.hasOwnProperty;var A=(e,r)=>{for(var o in r)j(e,o,{get:r[o],enumerable:!0})},w=(e,r,o,s)=>{if(r&&typeof r=="object"||typeof r=="function")for(let a of F(r))!E.call(e,a)&&a!==o&&j(e,a,{get:()=>r[a],enumerable:!(s=I(r,a))||s.enumerable});return e};var N=e=>w(j({},"__esModule",{value:!0}),e);var k={};A(k,{authentication:()=>J,memoryStorage:()=>R,staticToken:()=>$});module.exports=N(k);var K={fetch:globalThis.fetch,WebSocket:globalThis.WebSocket,URL:globalThis.URL};function D(e){return typeof e!="object"||!e?!1:"headers"in e&&"ok"in e&&"json"in e&&typeof e.json=="function"&&"text"in e&&typeof e.json=="function"}async function O(e){if(!(typeof e!="object"||!e)){if(D(e)){let r=e.headers.get("Content-Type")?.toLowerCase();if(r?.startsWith("application/json")||r?.startsWith("application/health+json")){let o=await e.json();if(!e.ok)throw o;return"data"in o?o.data:o}if(r?.startsWith("text/html")||r?.startsWith("text/plain")){let o=await e.text();if(!e.ok)throw o;return o}return e}return"data"in e?e.data:e}}var u=async(e,r,o=globalThis.fetch)=>{r.headers=typeof r.headers=="object"&&!Array.isArray(r.headers)?r.headers:{};let s=await o(e,r);return O(s).catch(a=>{throw{errors:typeof a=="object"&&"errors"in a?a.errors:a,response:s}})};var P=e=>{let r={};if(Array.isArray(e.fields)&&e.fields.length>0){let o=(s,a=[])=>{if(typeof s=="object"){let i=[];for(let m in s){let p=s[m]??[];if(Array.isArray(p))for(let h of p)i.push(o(h,[...a,m]));else if(typeof p=="object")for(let h of Object.keys(p)){let T=p[h];for(let f of T)i.push(o(f,[...a,`${m}:${h}`]))}}return i.flatMap(m=>m)}return[...a,String(s)].join(".")};r.fields=e.fields.flatMap(s=>o(s)).join(",")}e.filter&&Object.keys(e.filter).length>0&&(r.filter=JSON.stringify(e.filter)),e.search&&(r.search=e.search),"sort"in e&&e.sort&&(r.sort=typeof e.sort=="string"?e.sort:e.sort.join(",")),typeof e.limit=="number"&&e.limit>=-1&&(r.limit=String(e.limit)),typeof e.offset=="number"&&e.offset>=0&&(r.offset=String(e.offset)),typeof e.page=="number"&&e.page>=1&&(r.page=String(e.page)),e.deep&&Object.keys(e.deep).length>0&&(r.deep=JSON.stringify(e.deep)),e.alias&&Object.keys(e.alias).length>0&&(r.alias=JSON.stringify(e.alias)),e.aggregate&&Object.keys(e.aggregate).length>0&&(r.aggregate=JSON.stringify(e.aggregate)),e.groupBy&&e.groupBy.length>0&&(r.groupBy=e.groupBy.join(","));for(let[o,s]of Object.entries(e))o in r||(typeof s=="string"||typeof s=="number"||typeof s=="boolean"?r[o]=String(s):r[o]=JSON.stringify(s));return r};var b="/",v=(e,r)=>(e.endsWith(b)&&(e=e.slice(0,-1)),r.startsWith(b)||(r=b+r),e+r),y=(e,r,o)=>{let s=e.pathname===b?r:v(e.pathname,r),a=new globalThis.URL(s,e);if(o)for(let[i,m]of Object.entries(P(o)))if(m&&typeof m=="object"&&!Array.isArray(m))for(let[p,h]of Object.entries(m))a.searchParams.set(`${i}[${p}]`,String(h));else a.searchParams.set(i,m);return a};var R=()=>{let e=null;return{get:async()=>e,set:async r=>{e=r}}};var U={msRefreshBeforeExpires:3e4,autoRefresh:!0},J=(e="cookie",r={})=>o=>{let s={...U,...r},a=null,i=null,m=s.storage??R(),p=()=>{m.set({access_token:null,refresh_token:null,expires:null,expires_at:null})},h=async()=>{try{await a}finally{a=null}},T=async()=>{let c=await m.get();if(a||!c?.expires_at){await h();return}c.expires_at<new Date().getTime()+s.msRefreshBeforeExpires&&C().catch(n=>{}),await h()},f=c=>{let n=c.expires??0;c.expires_at=new Date().getTime()+n,m.set(c),s.autoRefresh&&n>s.msRefreshBeforeExpires&&n<Number.MAX_SAFE_INTEGER&&(i&&clearTimeout(i),i=setTimeout(()=>{i=null,C().catch(d=>{})},n-s.msRefreshBeforeExpires))},C=async()=>(a=(async()=>{let n=await m.get();p();let d={method:"POST",headers:{"Content-Type":"application/json"}};"credentials"in s&&(d.credentials=s.credentials);let x={mode:e};e==="json"&&n?.refresh_token&&(x.refresh_token=n.refresh_token),d.body=JSON.stringify(x);let S=y(o.url,"/auth/refresh"),l=await u(S.toString(),d,o.globals.fetch);return f(l),l})().catch(n=>{throw n}),a);return{refresh:C,async login(c,n,d={}){p();let x=y(o.url,"/auth/login"),S={email:c,password:n};"otp"in d&&(S.otp=d.otp),S.mode=d.mode??e;let l={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(S)};"credentials"in s&&(l.credentials=s.credentials);let g=await u(x.toString(),l,o.globals.fetch);return f(g),g},async logout(){let c=await m.get(),n={method:"POST",headers:{"Content-Type":"application/json"}};"credentials"in s&&(n.credentials=s.credentials),e==="json"&&c?.refresh_token&&(n.body=JSON.stringify({refresh_token:c.refresh_token}));let d=y(o.url,"/auth/logout");await u(d.toString(),n,o.globals.fetch),i&&clearTimeout(i),p()},async getToken(){return await T(),(await m.get())?.access_token??null},setToken(c){m.set({access_token:c,refresh_token:null,expires:null,expires_at:null})}}};var $=e=>r=>{let o=e??null;return{async getToken(){return o},setToken(s){o=s}}};0&&(module.exports={authentication,memoryStorage,staticToken});
//# sourceMappingURL=index.cjs.map