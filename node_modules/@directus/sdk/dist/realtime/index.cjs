"use strict";var W=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames;var N=Object.prototype.hasOwnProperty;var T=(t,s)=>{for(var n in s)W(t,n,{get:s[n],enumerable:!0})},P=(t,s,n,d)=>{if(s&&typeof s=="object"||typeof s=="function")for(let u of L(s))!N.call(t,u)&&u!==n&&W(t,u,{get:()=>s[u],enumerable:!(d=A(s,u))||d.enumerable});return t};var R=t=>P(W({},"__esModule",{value:!0}),t);var U={};T(U,{auth:()=>g,generateUid:()=>w,messageCallback:()=>k,pong:()=>v,realtime:()=>I,sleep:()=>x});module.exports=R(U);function g(t){return JSON.stringify({...t,type:"auth"})}var v=()=>JSON.stringify({type:"pong"});var k=(t,s=1e3)=>new Promise((n,d)=>{let u=E=>{try{let S=JSON.parse(E.data);typeof S=="object"&&!Array.isArray(S)&&S!==null?(f(),n(S)):(f(),l())}catch{f(),n(E)}},l=()=>d(),f=()=>{clearTimeout(y),t.removeEventListener("message",u),t.removeEventListener("error",l),t.removeEventListener("close",l)};t.addEventListener("message",u),t.addEventListener("error",l),t.addEventListener("close",l);let y=setTimeout(()=>{f(),n(void 0)},s)});function*w(){let t=1;for(;;)yield String(t),t++}var M={authMode:"handshake",heartbeat:!0,reconnect:{delay:1e3,retries:10}},b={OPEN:1,CLOSED:3};function I(t={}){return s=>{t={...M,...t};let n=null,d=w(),u=0,l=!1,f=e=>"getToken"in e,y=async(e,r)=>{if(t.authMode==="strict"&&f(r)){let o=await r.getToken();o&&e.searchParams.set("access_token",o)}return e},E=async e=>{if("url"in t)return await y(new s.globals.URL(t.url),e);if(["ws:","wss:"].includes(s.url.protocol))return await y(s.url,e);let r=new s.globals.URL(s.url.toString());return r.protocol=s.url.protocol==="https:"?"wss:":"ws:",r.pathname="/websocket",await y(r,e)},S=()=>{n=null,d=w()};function C(){t.reconnect&&!l&&u<t.reconnect.retries?(l=!0,setTimeout(()=>{u+=1,this.connect().then(()=>{u=0,l=!1}).catch(()=>{})},Math.max(1,t.reconnect.delay))):l=!1}let p={open:new Set([]),error:new Set([]),close:new Set([]),message:new Set([])},O=async(e,r)=>{for(;e.readyState!==b.CLOSED;){let o=await k(e).catch(()=>{});if(o){if("type"in o){if(o.type==="auth"&&"status"in o&&o.status==="error"&&"error"in o){if(o.error==="TOKEN_EXPIRED"&&f(r)){let a=await r.getToken();if(a){e.send(g({access_token:a}));continue}}if(o.error==="AUTH_TIMEOUT"){e.close();continue}}if(t.heartbeat&&o.type==="ping"){e.send(v());continue}}p.message.forEach(a=>a.call(e,o))}}};return{async connect(){let e=this,r=await E(e);return new Promise((o,a)=>{let m=!1,c=new s.globals.WebSocket(r);c.addEventListener("open",async i=>{if(t.authMode==="handshake"&&f(e)){let h=await e.getToken();h&&c.send(g({access_token:h}))}m=!0,p.open.forEach(h=>h.call(c,i)),O(c,e),o()}),c.addEventListener("error",i=>{p.error.forEach(h=>h.call(c,i)),c.close(),m||a(i)}),c.addEventListener("close",i=>{p.close.forEach(h=>h.call(c,i)),S(),C.call(this),m||a(i)}),n=c})},disconnect(){n&&n?.readyState===b.OPEN&&n.close(),n=null},onWebSocket(e,r){if(e==="message"){let o=function(a){if(typeof a.data!="string")return r.call(this,a);try{return r.call(this,JSON.parse(a.data))}catch{return r.call(this,a)}};return p[e].add(o),()=>p[e].delete(o)}return p[e].add(r),()=>p[e].delete(r)},sendMessage(e){if(!n||n?.readyState!==b.OPEN)throw new Error("websocket connection not OPEN");if(typeof e=="string"){n.send(e);return}"uid"in e||(e.uid=d.next().value),n?.send(JSON.stringify(e))},async subscribe(e,r={}){(!n||n.readyState!==b.OPEN)&&await this.connect(),"uid"in r||(r.uid=d.next().value);let o=!0,a=n,m=i=>a.send(JSON.stringify(i));m({...r,collection:e,type:"subscribe"});async function*c(){for(;o&&a&&a.readyState===b.OPEN;){let i=await k(a).catch(()=>{});if(i){if("type"in i&&"status"in i&&i.type==="subscribe"&&i.status==="error")throw i;"type"in i&&"uid"in i&&i.type==="subscription"&&i.uid===r.uid&&(yield i)}}if(t.reconnect&&l){for(;l;)await x(10);n&&n.readyState===b.OPEN&&(n.send(JSON.stringify({...r,collection:e,type:"subscribe"})),yield*c())}}return{subscription:c(),unsubscribe(){m({uid:r.uid,type:"unsubscribe"}),o=!1}}}}}}var x=t=>new Promise(s=>setTimeout(()=>s(),t));0&&(module.exports={auth,generateUid,messageCallback,pong,realtime,sleep});
//# sourceMappingURL=index.cjs.map